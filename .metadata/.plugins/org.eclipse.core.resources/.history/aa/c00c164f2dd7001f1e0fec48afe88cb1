/*
 * OBD2.c
 *
 *  Created on: Jan 11, 2025
 *      Author: rhett
 */

#include <stm32f7xx.h>
#include <stdio.h>
#include <stdbool.h>
#include "OBD2.h"
#include "lvgl.h"
#include "ui.h"

void send_debug_header(OBDBus* bus, bool receiving) {
	char header[DBG_MSG_MAX_SIZE];
	if (lv_textarea_get_cursor_pos(objects.obj27) > 272) {
		lv_label_cut_text(lv_textarea_get_label(objects.obj27), 0, 68);
		//lv_textarea_set_text(objects.obj27, lv_textarea_get_label(objects.obj27));
	}
	if (!receiving) {
		sprintf(header, "#00FF00 [DGAS]#");
	} else {
		sprintf(header, "#AAAAAA [ECU]#");
	}
	if (bus->status == OBD_LIVE) {
		sprintf(header, "#00FFFF <Data>#");
	}  else {
		sprintf(header, "#11FFAA <Init>#");
	}
	lv_textarea_add_text(objects.obj27, header);
	lv_label_set_recolor(lv_textarea_get_label(objects.obj27), true);
}

HAL_StatusTypeDef obd2_get_pid(OBDBus* bus, uint8_t pid, uint8_t* response) {
	send_debug_header(bus, false);
	if (bus->get_pid(pid, response) != HAL_OK) {
		return HAL_ERROR;
	}
	return HAL_OK;
}

HAL_StatusTypeDef obd2_get_rpm(OBDBus* bus, uint16_t* rpm) {
	uint8_t response[OBD2_DATA_MAX] = {0};

	if (obd2_get_pid(bus, OBD2_PID_RPM, response) != HAL_OK) {
		return HAL_ERROR;
	}
	*rpm = (256*response[0] + response[1]) / 4;
	return HAL_OK;
}
