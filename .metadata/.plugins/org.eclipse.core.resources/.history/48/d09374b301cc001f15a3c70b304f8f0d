/*
 * ST7701.c
 *
 *  Created on: Jan 4, 2025
 *      Author: rhett
 */

#include <stm32f7xx.h>
#include "ST7701.h"

extern SPI_HandleTypeDef hspi1;

HAL_StatusTypeDef lcd_command(uint16_t cmd, uint16_t arg) {
	uint8_t args[] = {cmd >> 8, cmd, arg >> 8};

	HAL_GPIO_WritePin(GPIOB, LCD_CS, 0);
	if (HAL_SPI_Transmit(&hspi1, args, 3, 100) != HAL_OK) {
		HAL_GPIO_WritePin(GPIOB, LCD_CS, 1);
		return HAL_ERROR;
	}
	HAL_GPIO_WritePin(GPIOB, LCD_CS, 1);
	return HAL_OK;
}

void lcd_reset(void) {
	HAL_GPIO_WritePin(GPIOB, LCD_NRST, 0);
	HAL_Delay(10);
	HAL_GPIO_WritePin(GPIOB, LCD_NRST, 1);
	HAL_Delay(10);
}

void WriteComm(uint8_t cmd) {
	uint16_t send = cmd;
	HAL_GPIO_WritePin(GPIOB, LCD_CS, 0);
	HAL_SPI_Transmit(&hspi1, &send, 1, 100);
	HAL_GPIO_WritePin(GPIOB, LCD_CS, 1);
}

void WriteData(uint8_t data) {
	uint16_t send = 1 << 8 | data;
	HAL_GPIO_WritePin(GPIOB, LCD_CS, 0);
	HAL_SPI_Transmit(&hspi1, &send, 1, 100);
	HAL_GPIO_WritePin(GPIOB, LCD_CS, 1);
}

HAL_StatusTypeDef lcd_init(void) {
	HAL_GPIO_WritePin(GPIOB, LCD_NRST, 1);
	HAL_GPIO_WritePin(GPIOB, LCD_CS, 1);
	lcd_reset();
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x13);
	WriteComm (0xEF);
	WriteData (0x08);
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x10);
	WriteComm (0xC0);
	WriteData (0x3B);
	WriteData (0x00);
	WriteComm (0xC1);
	WriteData (0x0B);
	WriteData (0x02);
	WriteComm (0xC2);
	WriteData (0x00);
	WriteData (0x02);
	WriteComm (0xCC);
	WriteData (0x10);
	//WriteComm (0xCD);
	//WriteData (0x08);
	WriteComm (0xB0);
	WriteData (0x00);
	WriteData (0x1D);
	WriteData (0x29);
	WriteData (0x12);
	WriteData (0x17);
	WriteData (0x0B);
	WriteData (0x18);
	WriteData (0x09);
	WriteData (0x08);
	WriteData (0x2A);
	WriteData (0x07);
	WriteData (0x14);
	WriteData (0x11);
	WriteData (0x27);
	WriteData (0x32);
	WriteData (0x1F);
	WriteComm (0xB1);
	WriteData (0x00);
	WriteData (0x1D);
	WriteData (0x29);
	WriteData (0x12);
	WriteData (0x16);
	WriteData (0x0A);
	WriteData (0x18);
	WriteData (0x08);
	WriteData (0x09);
	WriteData (0x2A);
	WriteData (0x07);
	WriteData (0x13);
	WriteData (0x12);
	WriteData (0x27);
	WriteData (0x33);
	WriteData (0x1F);
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x11);
	WriteComm (0xB0);
	WriteData (0x9D);
	WriteComm (0xB1);
	WriteData (0x24);
	WriteComm (0xB2);
	WriteData (0x81);
	WriteComm (0xB3);
	WriteData (0x80);
	WriteComm (0xB5);
	WriteData (0x43);
	WriteComm (0xB7);
	WriteData (0x85);
	WriteComm (0xB8);
	WriteData (0x20);
	WriteComm (0xC1);
	WriteData (0x78);
	WriteComm (0xC2);
	WriteData (0x78);
	WriteComm (0xD0);
	WriteData (0x88);
	WriteComm (0xE0);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x02);
	WriteComm (0xE1);
	WriteData (0x03);
	WriteData (0xA0);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x04);
	WriteData (0xA0);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x20);
	WriteData (0x20);
	WriteComm (0xE2);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0xE3);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x11);
	WriteData (0x00);
	WriteComm (0xE4);
	WriteData (0x22);
	WriteData (0x00);
	WriteComm (0xE5);
	WriteData (0x05);
	WriteData (0xEC);
	WriteData (0xA0);
	WriteData (0xA0);
	WriteData (0x07);
	WriteData (0xEE);
	WriteData (0xA0);
	WriteData (0xA0);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0xE6);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x11);
	WriteData (0x00);
	WriteComm (0xE7);
	WriteData (0x22);
	WriteData (0x00);
	WriteComm (0xE8);
	WriteData (0x06);
	WriteData (0xED);
	WriteData (0xA0);
	WriteData (0xA0);
	WriteData (0x08);
	WriteData (0xEF);
	WriteData (0xA0);
	WriteData (0xA0);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0xEB);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x40);
	WriteData (0x40);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0xED);
	WriteData (0xFF);
	WriteData (0xFF);
	WriteData (0xFF);
	WriteData (0xBA);
	WriteData (0x0A);
	WriteData (0xBF);
	WriteData (0x45);
	WriteData (0xFF);
	WriteData (0xFF);
	WriteData (0x54);
	WriteData (0xFB);
	WriteData (0xA0);
	WriteData (0xAB);
	WriteData (0xFF);
	WriteData (0xFF);
	WriteData (0xFF);
	WriteComm (0xEF);
	WriteData (0x10);
	WriteData (0x0D);
	WriteData (0x04);
	WriteData (0x08);
	WriteData (0x3F);
	WriteData (0x1F);
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x13);
	WriteComm (0xE8);
	WriteData (0x00);
	WriteData (0x0E);
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0x11);
	HAL_Delay(120);
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x13);
	WriteComm (0xE8);
	WriteData (0x00);
	WriteData (0x0C);
	HAL_Delay(10);
	WriteComm (0xE8);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0xFF);
	WriteData (0x77);
	WriteData (0x01);
	WriteData (0x00);
	WriteData (0x00);
	WriteData (0x00);
	WriteComm (0x29);
	HAL_Delay(20);
	return HAL_OK;
}
